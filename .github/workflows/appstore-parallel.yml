name: App Store Release (Parallel)

on:
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  NODE_VERSION: '20'
  APP_NAME: 'ProcHub'
  BUNDLE_ID: 'prochub'
  APPLE_APP_ID: '6759326945'

# ============================================================
# Job layout:
#
#   build-arm64 ──┐
#                 ├──▶ upload (uploads both PKGs simultaneously)
#   build-amd64 ──┘
#
# ============================================================

jobs:
  # ------------------------------------------------------------------ #
  # Job 1: Build arm64
  # ------------------------------------------------------------------ #
  build-arm64:
    name: Build (arm64)
    runs-on: macos-latest
    outputs:
      app-version: ${{ steps.version.outputs.app_version }}
      build-number: ${{ steps.buildnum.outputs.build_number }}
      pkg-name: ${{ steps.pkg.outputs.pkg_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          VERSION=$(sed -n 's/.*Version:[[:space:]]*"v\([^"]*\)".*/\1/p' app.go | head -1)
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Version: $VERSION"

      - name: Compute build number
        id: buildnum
        run: |
          VER="${{ env.APP_VERSION }}"
          MAJOR=$(echo "$VER" | cut -d. -f1)
          MINOR=$(echo "$VER" | cut -d. -f2)
          PATCH=$(echo "$VER" | cut -d. -f3)
          BUILD_NUMBER=$(printf "%d%02d%02d" "$MAJOR" "$MINOR" "$PATCH")
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "Build number: $BUILD_NUMBER"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd frontend && npm install

      - name: Import signing certificates
        env:
          CORP_MACOS_DIST_CERTIFICATE: ${{ secrets.CORP_MACOS_DIST_CERTIFICATE }}
          CORP_MACOS_DIST_CERTIFICATE_PASSWORD: ${{ secrets.CORP_MACOS_DIST_CERTIFICATE_PASSWORD }}
          CORP_MACOS_INSTALLER_CERTIFICATE: ${{ secrets.CORP_MACOS_INSTALLER_CERTIFICATE }}
          CORP_MACOS_INSTALLER_CERTIFICATE_PASSWORD: ${{ secrets.CORP_MACOS_INSTALLER_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          echo "$CORP_MACOS_DIST_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/dist.p12
          security import $RUNNER_TEMP/dist.p12 \
            -P "$CORP_MACOS_DIST_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH

          echo "$CORP_MACOS_INSTALLER_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/installer.p12
          security import $RUNNER_TEMP/installer.p12 \
            -P "$CORP_MACOS_INSTALLER_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH

          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          DIST_IDENTITY=$(security find-identity -v -p codesigning $KEYCHAIN_PATH \
            | grep "Apple Distribution" | head -1 | awk -F'"' '{print $2}')
          INSTALLER_IDENTITY=$(security find-identity -v -p basic $KEYCHAIN_PATH \
            | grep -E "Mac Installer Distribution|3rd Party Mac Developer Installer" | head -1 | awk -F'"' '{print $2}')

          echo "DIST_IDENTITY=$DIST_IDENTITY"           >> $GITHUB_ENV
          echo "INSTALLER_IDENTITY=$INSTALLER_IDENTITY" >> $GITHUB_ENV

      - name: Build app (arm64)
        run: wails build -platform darwin/arm64 -trimpath -ldflags "-s -w"

      - name: Set version in Info.plist
        run: |
          PLIST="build/bin/${{ env.APP_NAME }}.app/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ env.APP_VERSION }}" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ env.BUILD_NUMBER }}"           "$PLIST"

      - name: Embed provisioning profile
        env:
          CORP_MACOS_PROVISIONING_PROFILE: ${{ secrets.CORP_MACOS_PROVISIONING_PROFILE }}
        run: |
          echo "$CORP_MACOS_PROVISIONING_PROFILE" | base64 --decode \
            > "build/bin/${{ env.APP_NAME }}.app/Contents/embedded.provisionprofile"

      - name: Sign app bundle
        run: |
          APP_PATH="build/bin/${{ env.APP_NAME }}.app"
          ENTITLEMENTS="build/darwin/entitlements.plist"
          find "$APP_PATH" \( -name "*.dylib" -o -name "*.framework" \) | while read lib; do
            codesign --force --options runtime --sign "$DIST_IDENTITY" "$lib" || true
          done
          if [ -f "$ENTITLEMENTS" ]; then
            codesign --force --deep --options runtime \
              --entitlements "$ENTITLEMENTS" --sign "$DIST_IDENTITY" "$APP_PATH"
          else
            codesign --force --deep --options runtime --sign "$DIST_IDENTITY" "$APP_PATH"
          fi
          codesign --verify --verbose=4 "$APP_PATH"

      - name: Create PKG installer
        id: pkg
        run: |
          PKG_NAME="${{ env.APP_NAME }}-${{ env.APP_VERSION }}-arm64.pkg"
          if [ -z "$INSTALLER_IDENTITY" ]; then
            echo "ERROR: INSTALLER_IDENTITY is empty."
            exit 1
          fi
          productbuild \
            --component "build/bin/${{ env.APP_NAME }}.app" /Applications \
            --sign "$INSTALLER_IDENTITY" \
            "$PKG_NAME"
          echo "pkg_name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "PKG created: $PKG_NAME"

      - name: Upload PKG artifact
        uses: actions/upload-artifact@v4
        with:
          name: pkg-arm64
          path: ${{ steps.pkg.outputs.pkg_name }}
          retention-days: 1

  # ------------------------------------------------------------------ #
  # Job 2: Build amd64  (runs in parallel with build-arm64)
  # ------------------------------------------------------------------ #
  build-amd64:
    name: Build (amd64)
    runs-on: macos-latest
    outputs:
      app-version: ${{ steps.version.outputs.app_version }}
      build-number: ${{ steps.buildnum.outputs.build_number }}
      pkg-name: ${{ steps.pkg.outputs.pkg_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          VERSION=$(sed -n 's/.*Version:[[:space:]]*"v\([^"]*\)".*/\1/p' app.go | head -1)
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Version: $VERSION"

      - name: Compute build number
        id: buildnum
        run: |
          VER="${{ env.APP_VERSION }}"
          MAJOR=$(echo "$VER" | cut -d. -f1)
          MINOR=$(echo "$VER" | cut -d. -f2)
          PATCH=$(echo "$VER" | cut -d. -f3)
          BUILD_NUMBER=$(printf "%d%02d%02d" "$MAJOR" "$MINOR" "$PATCH")
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "Build number: $BUILD_NUMBER"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd frontend && npm install

      - name: Import signing certificates
        env:
          CORP_MACOS_DIST_CERTIFICATE: ${{ secrets.CORP_MACOS_DIST_CERTIFICATE }}
          CORP_MACOS_DIST_CERTIFICATE_PASSWORD: ${{ secrets.CORP_MACOS_DIST_CERTIFICATE_PASSWORD }}
          CORP_MACOS_INSTALLER_CERTIFICATE: ${{ secrets.CORP_MACOS_INSTALLER_CERTIFICATE }}
          CORP_MACOS_INSTALLER_CERTIFICATE_PASSWORD: ${{ secrets.CORP_MACOS_INSTALLER_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          echo "$CORP_MACOS_DIST_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/dist.p12
          security import $RUNNER_TEMP/dist.p12 \
            -P "$CORP_MACOS_DIST_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH

          echo "$CORP_MACOS_INSTALLER_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/installer.p12
          security import $RUNNER_TEMP/installer.p12 \
            -P "$CORP_MACOS_INSTALLER_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH

          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          DIST_IDENTITY=$(security find-identity -v -p codesigning $KEYCHAIN_PATH \
            | grep "Apple Distribution" | head -1 | awk -F'"' '{print $2}')
          INSTALLER_IDENTITY=$(security find-identity -v -p basic $KEYCHAIN_PATH \
            | grep -E "Mac Installer Distribution|3rd Party Mac Developer Installer" | head -1 | awk -F'"' '{print $2}')

          echo "DIST_IDENTITY=$DIST_IDENTITY"           >> $GITHUB_ENV
          echo "INSTALLER_IDENTITY=$INSTALLER_IDENTITY" >> $GITHUB_ENV

      - name: Build app (amd64)
        run: wails build -platform darwin/amd64 -trimpath -ldflags "-s -w"

      - name: Set version in Info.plist
        run: |
          PLIST="build/bin/${{ env.APP_NAME }}.app/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ env.APP_VERSION }}" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ env.BUILD_NUMBER }}"           "$PLIST"

      - name: Embed provisioning profile
        env:
          CORP_MACOS_PROVISIONING_PROFILE: ${{ secrets.CORP_MACOS_PROVISIONING_PROFILE }}
        run: |
          echo "$CORP_MACOS_PROVISIONING_PROFILE" | base64 --decode \
            > "build/bin/${{ env.APP_NAME }}.app/Contents/embedded.provisionprofile"

      - name: Sign app bundle
        run: |
          APP_PATH="build/bin/${{ env.APP_NAME }}.app"
          ENTITLEMENTS="build/darwin/entitlements.plist"
          find "$APP_PATH" \( -name "*.dylib" -o -name "*.framework" \) | while read lib; do
            codesign --force --options runtime --sign "$DIST_IDENTITY" "$lib" || true
          done
          if [ -f "$ENTITLEMENTS" ]; then
            codesign --force --deep --options runtime \
              --entitlements "$ENTITLEMENTS" --sign "$DIST_IDENTITY" "$APP_PATH"
          else
            codesign --force --deep --options runtime --sign "$DIST_IDENTITY" "$APP_PATH"
          fi
          codesign --verify --verbose=4 "$APP_PATH"

      - name: Create PKG installer
        id: pkg
        run: |
          PKG_NAME="${{ env.APP_NAME }}-${{ env.APP_VERSION }}-amd64.pkg"
          if [ -z "$INSTALLER_IDENTITY" ]; then
            echo "ERROR: INSTALLER_IDENTITY is empty."
            exit 1
          fi
          productbuild \
            --component "build/bin/${{ env.APP_NAME }}.app" /Applications \
            --sign "$INSTALLER_IDENTITY" \
            "$PKG_NAME"
          echo "pkg_name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "PKG created: $PKG_NAME"

      - name: Upload PKG artifact
        uses: actions/upload-artifact@v4
        with:
          name: pkg-amd64
          path: ${{ steps.pkg.outputs.pkg_name }}
          retention-days: 1

  # ------------------------------------------------------------------ #
  # Job 3: Upload both PKGs to App Store Connect simultaneously
  #         (runs after both build jobs complete)
  # ------------------------------------------------------------------ #
  upload:
    name: Upload to App Store Connect
    runs-on: macos-latest
    needs: [build-arm64, build-amd64]

    steps:
      - name: Download arm64 PKG
        uses: actions/download-artifact@v4
        with:
          name: pkg-arm64
          path: ./pkgs

      - name: Download amd64 PKG
        uses: actions/download-artifact@v4
        with:
          name: pkg-amd64
          path: ./pkgs

      - name: List PKGs
        run: ls -lh pkgs/

      - name: Upload both PKGs simultaneously
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_VERSION: ${{ needs.build-arm64.outputs.app-version }}
          BUILD_NUMBER: ${{ needs.build-arm64.outputs.build-number }}
        run: |
          upload_pkg() {
            local pkg="$1"
            echo "==> Uploading $pkg (build $BUILD_NUMBER)..."
            xcrun altool --upload-package "$pkg" \
              --type macos \
              --apple-id "${{ env.APPLE_APP_ID }}" \
              --bundle-id "${{ env.BUNDLE_ID }}" \
              --bundle-version "$BUILD_NUMBER" \
              --bundle-short-version-string "$APP_VERSION" \
              --username "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --asc-provider "$APPLE_TEAM_ID" \
              --verbose
            echo "==> Done: $pkg"
          }

          PKG_ARM64=$(ls pkgs/*-arm64.pkg)
          PKG_AMD64=$(ls pkgs/*-amd64.pkg)

          # Launch both uploads in background, then wait for both to finish
          upload_pkg "$PKG_ARM64" &
          PID_ARM64=$!

          upload_pkg "$PKG_AMD64" &
          PID_AMD64=$!

          wait $PID_ARM64
          STATUS_ARM64=$?

          wait $PID_AMD64
          STATUS_AMD64=$?

          echo "arm64 upload exit code : $STATUS_ARM64"
          echo "amd64 upload exit code : $STATUS_AMD64"

          [ $STATUS_ARM64 -eq 0 ] && [ $STATUS_AMD64 -eq 0 ] || exit 1
          echo "Both uploads complete - check App Store Connect for processing status"

      - name: Save PKGs as workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-appstore-${{ needs.build-arm64.outputs.app-version }}
          path: pkgs/
          retention-days: 14
